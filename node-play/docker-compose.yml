version: "3.7"

services:
  geth-bootnode:
    hostname: geth-bootnode
    env_file: .env
    image: geth-client
    build:
      context: .
      args:
        - ACCOUNT_PASSWORD=${ACCOUNT_PASSWORD}
    command:
      [
        "--nodekeyhex=48044a972830ae92ebb62f33c2aa279fc90b7a00f3730346f059608becaa7e0b",
        "--nodiscover",
        "--ipcdisable",
        "--networkid=${NETWORK_ID}",
        "--netrestrict=172.16.254.0/28",
        "--port=${NETWORK_PORT}",
      ]
    networks:
      - priv-eth-net

  geth-rpc-endpoint:
    hostname: geth-rpc-endpoint
    env_file: .env
    image: geth-client
    build:
      context: .
      args:
        - ACCOUNT_PASSWORD=${ACCOUNT_PASSWORD}
    depends_on:
      - geth-bootnode
    command:
      [
        "--bootnodes=enode://95ab6f81910f9cd9f8d319d45c9a07f2f0eff97ac9580880c5df301cf9baa8e6c9a76f43f6fcb9d36f7599d206b79922a876802fffc9e9c3f9acbb849631a86d@geth-bootnode:${NETWORK_PORT}",
        "--allow-insecure-unlock",
        "--http",
        "--http.addr=0.0.0.0",
        "--http.api=eth,web3,net,admin,txpool,clique,personal",
        "--http.corsdomain=*",
        "--networkid=${NETWORK_ID}",
        "--netrestrict=172.16.254.0/28",
      ]
    ports:
      - "8545:8545"
    networks:
      - priv-eth-net

  geth-miner:
    hostname: geth-miner
    env_file: .env
    image: geth-client
    build:
      context: .
      args:
        - ACCOUNT_PASSWORD=${ACCOUNT_PASSWORD}
    depends_on:
      - geth-bootnode
    command:
      [
        "--bootnodes=enode://95ab6f81910f9cd9f8d319d45c9a07f2f0eff97ac9580880c5df301cf9baa8e6c9a76f43f6fcb9d36f7599d206b79922a876802fffc9e9c3f9acbb849631a86d@geth-bootnode:${NETWORK_PORT}",
        "--mine",
        "--miner.etherbase=${SIGNER_ADDRESS}",
        "--miner.gasprice=10",
        "--unlock=${SIGNER_ADDRESS}",
        "--password=pwd.txt",
        "--networkid=${NETWORK_ID}",
        "--netrestrict=172.16.254.0/28",
      ]
    networks:
      - priv-eth-net

networks:
  priv-eth-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.16.254.0/28
